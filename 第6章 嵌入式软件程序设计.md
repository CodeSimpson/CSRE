## 第6章 嵌入式软件程序设计

### 1. 嵌入式系统开发与设计

#### 1.1 嵌入式应用开发的过程

硬件设计和软件设计相结合。

* 硬件的设计与实现
* 设备驱动软件的设计与实现
* 嵌入式操作系统的选择、移植，以及API接口函数的设计
* 支撑软件的设计与调试
* 应用程序的设计与调试
* 系统联调，样机交付

#### 1.2 嵌入式应用开发的特点

* 需要交叉编译工具
* 通过仿真手段进行调试
* 开发板是中间目标机
* 可利用资源有限
* 需要与硬件打交道

#### 1.3 开发模式三种：

* 本机开发
* 交叉开发
* 模拟开发

#### 1.4 嵌入式软件开发流程

* 嵌入式平台选型：硬件和软件平台选型
* 软件设计：功能划分，哪些由硬件实现，哪些由软件实现
* 特性设计：可靠性，实时性等
* 编码
* 测试
* 下载和运行

### 2. 嵌入式程序设计

#### 2.1 表达式

* 前缀表达式（+ a b）

* 中缀表达式（a + b）
* 后缀表达式（a b +），也称为逆波兰式

程序中用栈保存表达式，一般考表达式的转换。

#### 2.2 程序的编译过程

编译程序：也称编译器，生成目标语言程序。

解释程序：也称解释器，生成源代码或者中间代码。

根本区别在于是否生成独立的目标程序。

* 编译器基础

  * 符号表的作用是记录源程序中各个符号的必要信息，以辅助语义的正确性检查和代码生成，在编译过程中需要对符号表进行快速有效查找、插入、修改和删除操作。符号表的使用基本贯穿整个程序的编译过程。

  * 中间代码：中间代码生成阶段的工作是根据语义分析的输出生成中间代码。中间代码是一种简单且含义明确的记号系统，可以有若干形式，但**与具体机器无关**（目标代码和具体机器密切相关）

  * 中间代码的表示形式有**后缀式**、**三地址码**和**树**等。

    > 最常用的中间代码形式是三地址码，她的视线形式是四元式形式。

    * 后缀式：操作数在前，操作符在后

    * 三地址码：

      三元式：op, arg1, arg2

      四元式：op, arg1, arg2, result

    * 树：

  * 中间代码的优化：优化过程可以在中间代码生成阶段进行，也可以在目标代码生成阶段进行。由于中间代码不依赖具体的机器，此时所作的优化是建立在对程序的控制流和数据流分析的基础上，与具体机器无关，优化依据原则是程序的等价变换规则。（**中间代码优化与机器无关**）

    



* 编译器的工作阶段

  * 词法分析工作：将源代码的字符序列转换为有意义的单词序列，词法分析器的主要任务是将源代码分解为单个的词法单元，例如关键字、标识符、运算符、分隔符等。

  * 语法分析工作：将词法单元序列转换为程序的语法结构，例如语句、表达式、函数等，语法分析器的主要任务是检查词法单元序列是否符合语法规则，并生成语法树。

  *  语义分析工作：==类型检查==、控制流检查、变量和函数的作用域检查、一致性检查、表达式求值、符号表管理、错误处理、中间代码生成

    > [语义分析（Semantic Analysis） - guanyubo - 博客园 (cnblogs.com)](https://www.cnblogs.com/yubo-guan/p/18063348#:~:text=类型检查是语义分析的核心任务之一，用于确保源程序中的表达式和语句在类型上是正确的。,编译器会检查每个表达式中的操作数类型是否与操作符兼容，以及赋值语句中的左值和右值类型是否匹配等。 如果发现类型错误，编译器会生成相应的错误消息。)


<img src="./pic/chapter6/screenshot.jpeg" style="zoom: 50%;" />

词法错误：非法字符、关键字或标识符拼写错误，==输入为源程序==。

语法错误：语法结构出错，if ... end if不匹配，缺分号等，==输入为记号流==。

语义错误：死循环，零除数，其他逻辑错误等，==输入为语法树==。

中间代码生成：“中间代码”是一种简单且含义明确的记号系统，有若干形式，与具体机器无关。

目标代码生成：和机器强相关。

* 解释程序的基本原理

另一种语言处理程序，在词法、语法和语义分析方面与编译程序的工作原理基本相同。但在运行用户程序时，它直接执行源程序或源程序的内部形式。因此，解释程序与编译程序最大的区别就是不产生源程序的目标程序。

可以将解释程序分为两个部分：

1. 分析部分，包括通常的词法分析、语法分析和语义分析程序，经分析后把源程序翻译为中间代码。
2. 解释部分，用来对第一部分所产生的中间代码进行解释执行。

#### 2.3 面向过程的语言

* c语言预定义宏

<img src="./pic/chapter6/screenshot1.jpeg" style="zoom:50%;" />

* 存储管理

一个程序运行时的内存分布：

<img src="./pic/chapter6/screenshot2.jpeg" style="zoom:50%;" />

* 面向对象
  * 多态：基类指针可以调用派生类方法
  * 重载：函数名相同，函数形参或者返回类型不同。
  * 覆盖：派生类替换基类的成员函数。

> c++三大特性：封装、多态、继承

Java语言特征：

* 采用即时编译：java最初是通过解释器进行解释执行的。

* 对象在堆空间分配：java所有的对象实例都是new出来的，所有的==对象实例以及数组==都要在堆上分配。

  > 注意这里和c++不同，c++数组根据定义方式不同，即可能在堆中也可能在栈中，而java只会在堆中。

x++：后置自增

```c++
int x = 5;
// 这里if条件不成立，x先判定后自增
if (x++>5)
{
}
```

++x：前置自增

```c++
int x = 6
// 这里输出6，x先打印输出后自减
printf("%d\n",x--)
```

#### 2.4 中断服务程序的特点

* 不能有返回值
* 不能传参
* 要尽可能短小精悍，不能做浮点运算
* 不要有阻塞性调用，类似printf.

### 3. 程序语言

程序语言的基本成分包括**数据**、**运算**、**控制**和**传输**，程序语言的数据成分是指一种程序语言的数据类型。数据是程序操作的对象，具有存储类型、数据类型、数据名称、作用域、生存周期等属性。

* 数据成分

按照数据组织形式，数据可以分为基本类型、用户定义类型、构造类型以及其他类型。

<img src="./pic/chapter6/screenshot3.jpg" style="zoom:50%;" />

* 运算成分

运算成分规定程序语言可以使用的运算符号和运算规则，大多数高级程序语言的基本运算分为算术运算、关系运算、逻辑运算、位运算。

* 控制成分

分为顺序结构、选择结构、循环结构

* 传输成分

指明语言允许的数据传输方式，赋值处理，数据的输入输出等。

> 函数是程序模块的主要组成部分。
